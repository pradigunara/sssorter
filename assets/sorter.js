var picSet1 = {
  SeoYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/c8eaea61-ae6f-4a58-e4e1-ca1d4a972e00/2x",
  HyeRin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/4ccc472d-b24b-45f9-0d8a-45e35bf19700/2x",
  JiWoo:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/1b64eca0-d460-44c6-da8c-bdf04473c300/2x",
  ChaeYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/f1e8add6-9449-467c-cc47-a51774243400/2x",
  YooYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/29428ed2-3e41-483f-cb52-33b20cb4fa00/2x",
  SooMin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/914dba60-68ca-4ad7-548e-67f224619500/2x",
  NaKyoung:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/df5f7323-185d-411c-1ade-a97042fd0500/2x",
  YuBin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/582ffc1a-c494-4d54-f48a-348b3f205000/2x",
  Kaede:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/237fedd1-1aea-41df-05ae-e9e116ae7500/2x",
  DaHyun:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/0c5094c9-fbf9-4fa5-147a-c4ced825e900/2x",
  Kotone:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/a24336bd-2b4d-4842-a7c5-8e0248c08d00/2x",
  YeonJi:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/8bfecaf0-02e4-481c-8e2c-0318803ed700/2x",
  Nien: "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/e79961b2-5f56-41d5-c248-04fa76f76000/2x",
  SoHyun:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/745a2808-af21-47d0-eea1-be71718c2600/2x",
  Xinyu:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/3d89bd5e-222f-4ef3-0ffd-6e38cd803800/2x",
  Mayu: "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/5c230d04-159e-42fd-4ffe-e629c7373d00/2x",
  Lynn: "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/85327937-56d8-4ad4-c4cd-45778199bd00/2x",
  JooBin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/3170e480-0e08-4e2a-3539-083241633100/2x",
  HaYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/ecc6f3eb-ebf0-4be1-dccd-c7b96f7dd200/2x",
  ShiOn:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/d6134145-d125-4cde-7ed9-13f36e5bba00/2x",
  ChaeWon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/79ec0b28-e63e-4657-f446-a32f55167000/2x",
  Sullin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/fe379953-8684-49b4-2fae-98968c018900/2x",
  SeoAh:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/e4ac2f4e-08db-4204-f203-29c769d58200/2x",
  JiYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/65fc5834-91da-4f5f-456f-ffa75c9aa300/2x",
};

var picSet2 = {
  SeoYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/64b04454-3acd-4d27-b040-604f664d0500/2x",
  HyeRin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/52c1c9da-63d3-4aca-8812-a4a74e9d0600/2x",
  JiWoo:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/76604ad2-8d82-464d-b71c-7bf3350a5200/2x",
  ChaeYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/1494a5ef-746b-4c73-6149-8858db2a6900/2x",
  YooYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/74e57513-d55c-414b-47d9-e4fbce23a400/2x",
  SooMin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/df583aa7-792d-49ca-b575-a6e568f92d00/2x",
  NaKyoung:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/0d2138b5-f26b-4095-ec18-f4a74cbe8500/2x",
  YuBin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/f06459a0-42a9-48a1-b423-4d7894052000/2x",
  Kaede:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/4c0780c9-a492-415b-8886-5bad283af500/2x",
  DaHyun:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/15bc6da3-275b-42f5-d96e-b7b90a21a800/2x",
  Kotone:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/8ad8bedb-5ec8-4ecc-0651-81f39d292800/2x",
  YeonJi:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/758979cd-3312-400f-0182-3fb8a87bd800/2x",
  Nien: "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/aa96fc5c-5bfd-42ea-bfd8-f81ca568b800/2x",
  SoHyun:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/5b7be708-aeb2-47b3-6e9c-ed711602e900/2x",
  Xinyu:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/f1c0966b-b6fa-4125-7b5d-ce04c91b2d00/2x",
  Mayu: "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/2e1ad6b9-3eff-4c04-3eba-c00d5f68b100/2x",
  Lynn: "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/fbb280ec-e19e-4ff4-9edb-776733ecd900/2x",
  JooBin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/4c121d16-546f-4c44-8f5c-5e648433ce00/2x",
  HaYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/030128b0-f966-45c5-f2b8-418413f73400/2x",
  ShiOn:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/dc5582f1-757b-4525-2520-dfc4d1231100/2x",
  ChaeWon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/c284da64-cc96-4457-6a86-f884749be000/2x",
  Sullin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/14dcb152-6a07-4551-ed2a-8107934bae00/2x",
  SeoAh:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/55460669-7972-49f6-4493-2a977f57b600/2x",
  JiYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/1f31faa4-9df2-4a84-7b02-58ed91288d00/2x",
};

var picSet3 = {
  SeoYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/8911a1cd-cba8-43eb-18e3-92536de92a00/2x",
  HyeRin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/24e537f2-9936-4b32-1994-30efad8c8a00/2x",
  JiWoo:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/28a49277-ed8e-40ed-864a-7fb7ef128d00/2x",
  ChaeYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/9f0dca17-1827-47cd-0440-e6b6e0f67900/2x",
  YooYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/3b21ec45-02ee-40fc-78c6-888dd7e5d800/2x",
  SooMin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/e238fe9f-1753-4114-140b-aeac40df3100/2x",
  NaKyoung:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/ec3354ea-2dc2-4d6c-5037-93cb520b5000/2x",
  YuBin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/59537afd-0ef3-4f92-af98-41e242828000/2x",
  Kaede:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/68fae808-9aca-4518-2a03-c94d4a2c5f00/2x",
  DaHyun:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/7b0bd21a-1643-487e-aa6a-76380f47a100/2x",
  Kotone:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/086fb95c-6135-4afc-6fd1-cdced86e9d00/2x",
  YeonJi:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/d9cd50d2-d266-4c89-e4fd-c5ce0707b100/2x",
  Nien: "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/8532c958-b11a-4bfd-1e37-54d762d72700/2x",
  SoHyun:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/d71a1f4b-90e0-4a5f-7411-2aa560197f00/2x",
  Xinyu:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/2870bbcd-5639-4404-cda8-056cdf04bf00/2x",
  Mayu: "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/6b0fb3e8-7cfc-444d-cc64-b2f61c9b6800/2x",
  Lynn: "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/94e1a74b-1f8f-4886-c402-809e14eb1900/2x",
  JooBin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/4580d694-4bc1-45df-16f1-ee8cc8d8d300/2x",
  HaYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/c3f08392-d51d-4b9b-ade3-6626ead20900/2x",
  ShiOn:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/7c49e490-445e-4170-4c78-7415dd7f9000/2x",
  ChaeWon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/cb9e5e39-3552-47cc-8afa-a853be520600/2x",
  Sullin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/c30fde2f-2adb-410c-15ef-0fb6bcc37c00/2x",
  SeoAh:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/9d48c0e3-57d4-42e6-bf0e-523f6b923b00/2x",
  JiYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/8f765952-216e-44fc-1bd3-f0df40dea600/2x",
};

var picSet4 = {
  SeoYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/c24dcff7-3083-4363-548c-0420275dcb00/2x",
  HyeRin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/1d849261-24b4-46dc-071f-2666a8b8df00/2x",
  JiWoo:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/bcd83b3d-cb1c-45f0-28b5-a01577886b00/2x",
  ChaeYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/d1c282a8-c0a4-4354-0cc6-3de5cc305100/2x",
  YooYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/4d0e696f-243c-4d3f-80b4-fd32ab7cc900/2x",
  SooMin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/9ad04024-f8e8-4c72-e315-1df02a9a9b00/2x",
  NaKyoung:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/0f67bd16-be42-44aa-0239-7a847ccf5900/2x",
  YuBin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/e6160eb3-2963-41b0-9124-23e361163600/2x",
  Kaede:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/f7901f1b-0db7-49b8-0f93-d6aaa746b300/2x",
  DaHyun:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/71260e02-541a-4a0b-3174-c44b37ab1400/2x",
  Kotone:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/5c41b4ae-bc6f-43b0-7427-b0cc511d9700/2x",
  YeonJi:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/3966ee11-8648-4c93-b0f7-db099b8b6400/2x",
  Nien: "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/5f06866b-2e5c-48c3-799b-160be1b9c500/2x",
  SoHyun:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/549dbd02-94e5-40bd-bca7-8e7f9cc68800/2x",
  Xinyu:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/83b70428-ce00-43c6-2939-8cf6fc219400/2x",
  Mayu: "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/baa6a2e9-3cbc-4c98-13e1-c7c1e5a3d400/2x",
  Lynn: "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/e75b375e-ac1e-4b25-003b-f5b2d5397700/2x",
  JooBin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/2c2e1424-55b8-4c39-23ef-e8cc9724cc00/2x",
  HaYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/730c7ea4-6fed-48ca-89c2-9a7e5785f200/2x",
  ShiOn:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/5860ba26-7b62-4fbe-d63e-bc7c0b5fef00/2x",
  ChaeWon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/4b271ecb-96fc-421b-8b9c-b7e6cf74c100/2x",
  Sullin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/9d2fea70-8c56-4b83-f02e-58b83dd2e300/2x",
  SeoAh:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/6e447541-3f8c-451c-ce1e-3400e7782f00/2x",
  JiYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/511be17d-d3cd-46d7-fda5-9cb1ab647c00/2x",
};

var rand = (min, max) => Math.floor(Math.random() * (max - min + 1) + min);
var memberPicId = {};
initMemberPic();

function initMemberPic() {
  const isDarkMode = localStorage.getItem("darkMode") === "true";
  const picSets = isDarkMode ? [picSet3, picSet4] : [picSet1, picSet2];
  memberPicId = picSets[rand(0, 1)];
}

// Preload images
function preloadImages() {
  const picSets = [picSet1, picSet2, picSet3, picSet4];
  for (const picSet of picSets) {
    for (const member in picSet) {
      if (picSet.hasOwnProperty(member)) {
        const img = new Image();
        img.src = picSet[member];
      }
    }
  }
}

// Dark mode functionality
function toggleDarkMode() {
  const body = document.body;
  const isDarkMode = body.classList.toggle("dark-mode");
  const themeToggleText = document.querySelector(".theme-toggle-text");
  const themeToggleIcon = document.querySelector(".theme-toggle-icon svg");

  // Update toggle text and icon
  if (isDarkMode) {
    themeToggleText.textContent = "Light Mode";
    themeToggleIcon.innerHTML =
      '<path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
  } else {
    themeToggleText.textContent = "#DarkMode";
    themeToggleIcon.innerHTML =
      '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
  }

  // Save preference to localStorage
  localStorage.setItem("darkMode", isDarkMode);
  initMemberPic();
  showFinal({ skipIncrement: true });
}

// Check for saved theme preference on page load
document.addEventListener("DOMContentLoaded", function () {
  const savedDarkMode = localStorage.getItem("darkMode");
  initMemberPic();

  if (savedDarkMode === "true") {
    document.body.classList.add("dark-mode");
    document.querySelector(".theme-toggle-text").textContent = "Light Mode";
    document.querySelector(".theme-toggle-icon svg").innerHTML =
      '<path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
  }

  // Call preloadImages
  preloadImages();
});

var memberColor = {
  SeoYeon: "#21AEFE",
  HyeRin: "#830CE8",
  JiWoo: "#FDF70A",
  ChaeYeon: "#98C64A",
  YooYeon: "#DC0B74",
  SooMin: "#F985A4",
  NaKyoung: "#659AA0",
  YuBin: "#FDE4E0",
  Kaede: "#FDB634",
  DaHyun: "#FE9BD6",
  Kotone: "#E3C500",
  YeonJi: "#5974FA",
  Nien: "#FD963D",
  SoHyun: "#1223B2",
  Xinyu: "#CA1E20",
  Mayu: "#FB9074",
  Lynn: "#AC60B8",
  JooBin: "#B7F54C",
  HaYeon: "#52D8BB",
  ShiOn: "#FF428A",
  ChaeWon: "#C3A4E0",
  Sullin: "#7DBA8D",
  SeoAh: "#D0F3FF",
  JiYeon: "#FFAB64",
};

var memberEmoji = {
  SeoYeon: "🐶",
  HyeRin: "🐱",
  JiWoo: "🐻",
  ChaeYeon: "🦌",
  YooYeon: "🐰",
  SooMin: "🐿️",
  NaKyoung: "🐈",
  YuBin: "🐯",
  Kaede: "🍁",
  DaHyun: "🍒",
  Kotone: "🦭",
  YeonJi: "🦆",
  Nien: "🐑",
  SoHyun: "🐺",
  Xinyu: "🦊",
  Mayu: "🐇",
  Lynn: "🦈",
  JooBin: "🐣",
  HaYeon: "🐹",
  ShiOn: "🍞",
  ChaeWon: "🎀",
  Sullin: "⛄️",
  SeoAh: "☀️",
  JiYeon: "🦢",
};

var memberSNumber = {
  SeoYeon: "S1",
  HyeRin: "S2", 
  JiWoo: "S3",
  ChaeYeon: "S4",
  YooYeon: "S5",
  SooMin: "S6",
  NaKyoung: "S7",
  YuBin: "S8",
  Kaede: "S9",
  DaHyun: "S10",
  Kotone: "S11",
  YeonJi: "S12",
  Nien: "S13",
  SoHyun: "S14",
  Xinyu: "S15",
  Mayu: "S16",
  Lynn: "S17",
  JooBin: "S18",
  HaYeon: "S19",
  ShiOn: "S20",
  ChaeWon: "S21",
  Sullin: "S22",
  SeoAh: "S23",
  JiYeon: "S24",
};

var namMember = new Array(
  "SeoYeon",
  "HyeRin",
  "JiWoo",
  "ChaeYeon",
  "YooYeon",
  "SooMin",
  "NaKyoung",
  "YuBin",
  "Kaede",
  "DaHyun",
  "Kotone",
  "YeonJi",
  "Nien",
  "SoHyun",
  "Xinyu",
  "Mayu",
  "Lynn",
  "JooBin",
  "HaYeon",
  "ShiOn",
  "ChaeWon",
  "Sullin",
  "SeoAh",
  "JiYeon",
);

var lstMember = new Array();
var parent = new Array();
var equal = new Array();
var rec = new Array();
var cmp1, cmp2;
var head1, head2;
var nrec;
var numQuestion;
var totalSize;
var finishSize;
var finishFlag;

function initList() {
  const memEmojis = Object.values(memberEmoji);
  const topEmojis = memEmojis.slice(0, 12).join(" ");
  const botEmojis = memEmojis.slice(12).join(" ");
  document.getElementById("member-emojis").innerHTML =
    `${topEmojis}<br/>${botEmojis}`;
  namMember.sort(() => 0.5 - Math.random());

  var n = 0;
  var mid;
  var i;

  lstMember[n] = new Array();

  for (i = 0; i < namMember.length; i++) {
    lstMember[n][i] = i;
  }

  parent[n] = -1;
  totalSize = 0;
  n++;

  for (i = 0; i < lstMember.length; i++) {
    if (lstMember[i].length >= 2) {
      mid = Math.ceil(lstMember[i].length / 2);
      lstMember[n] = new Array();
      lstMember[n] = lstMember[i].slice(0, mid);
      totalSize += lstMember[n].length;
      parent[n] = i;
      n++;
      lstMember[n] = new Array();
      lstMember[n] = lstMember[i].slice(mid, lstMember[i].length);
      totalSize += lstMember[n].length;
      parent[n] = i;
      n++;
    }
  }

  for (i = 0; i < namMember.length; i++) {
    rec[i] = 0;
  }

  nrec = 0;

  for (i = 0; i <= namMember.length; i++) {
    equal[i] = -1;
  }

  cmp1 = lstMember.length - 2;
  cmp2 = lstMember.length - 1;
  head1 = 0;
  head2 = 0;
  numQuestion = 1;
  finishSize = 0;
  finishFlag = 0;
}

function sortList(flag) {
  var i;
  var str;

  if (flag < 0) {
    rec[nrec] = lstMember[cmp1][head1];
    head1++;
    nrec++;
    finishSize++;

    while (equal[rec[nrec - 1]] != -1) {
      rec[nrec] = lstMember[cmp1][head1];
      head1++;
      nrec++;
      finishSize++;
    }
  } else if (flag > 0) {
    rec[nrec] = lstMember[cmp2][head2];
    head2++;
    nrec++;
    finishSize++;

    while (equal[rec[nrec - 1]] != -1) {
      rec[nrec] = lstMember[cmp2][head2];
      head2++;
      nrec++;
      finishSize++;
    }
  } else {
    rec[nrec] = lstMember[cmp1][head1];
    head1++;
    nrec++;
    finishSize++;
    while (equal[rec[nrec - 1]] != -1) {
      rec[nrec] = lstMember[cmp1][head1];
      head1++;
      nrec++;
      finishSize++;
    }
    equal[rec[nrec - 1]] = lstMember[cmp2][head2];
    rec[nrec] = lstMember[cmp2][head2];
    head2++;
    nrec++;
    finishSize++;
    while (equal[rec[nrec - 1]] != -1) {
      rec[nrec] = lstMember[cmp2][head2];
      head2++;
      nrec++;
      finishSize++;
    }
  }

  if (head1 < lstMember[cmp1].length && head2 == lstMember[cmp2].length) {
    while (head1 < lstMember[cmp1].length) {
      rec[nrec] = lstMember[cmp1][head1];
      head1++;
      nrec++;
      finishSize++;
    }
  } else if (
    head1 == lstMember[cmp1].length &&
    head2 < lstMember[cmp2].length
  ) {
    while (head2 < lstMember[cmp2].length) {
      rec[nrec] = lstMember[cmp2][head2];
      head2++;
      nrec++;
      finishSize++;
    }
  }

  if (head1 == lstMember[cmp1].length && head2 == lstMember[cmp2].length) {
    for (i = 0; i < lstMember[cmp1].length + lstMember[cmp2].length; i++) {
      lstMember[parent[cmp1]][i] = rec[i];
    }

    lstMember.pop();
    lstMember.pop();
    cmp1 = cmp1 - 2;
    cmp2 = cmp2 - 2;
    head1 = 0;
    head2 = 0;

    if (head1 == 0 && head2 == 0) {
      for (i = 0; i < namMember.length; i++) {
        rec[i] = 0;
      }
      nrec = 0;
    }
  }

  if (cmp1 < 0) {
    const progressPercent = Math.floor((finishSize * 100) / totalSize);
    const heartCount = 5;
    const filledHearts = Math.floor((progressPercent / 100) * heartCount);
    const heartDisplay = "♥".repeat(filledHearts) + "♡".repeat(heartCount - filledHearts);
    str = `<strong>Gravity #${numQuestion - 1}</strong><br>${heartDisplay} ${progressPercent}% sorted`;
    document.getElementById("battleNumber").innerHTML = str;
    showResult();
    finishFlag = 1;
  } else {
    // Pass the flag to showFinal
    showFinal({ selectedFlag: flag });
  }
}

function showResult({ full = false } = {}) {
  var ranking = 1;
  var sameRank = 1;
  var str = "";
  var i;
  var listResult = [];

  var iterCount = full ? namMember.length : namMember.length / 2;

  str += "<div class='results-list'><h2>Bias Ranking Result</h2><ul>";
  for (i = 0; i < iterCount; i++) {
    const mem = namMember[lstMember[0][i]];
    const disp = `${mem}${memberEmoji[mem]}`;
    listResult.push(disp);

    str += "<li><span class='number'>" + ranking + "</span> " + disp + "</li>";

    if (i < iterCount - 1) {
      if (equal[lstMember[0][i]] == lstMember[0][i + 1]) {
        sameRank++;
      } else {
        ranking += sameRank;
        sameRank = 1;
      }
    }
  }

  str += "</ul>";
  document.getElementById("battleResult").innerHTML = str;
  document.getElementById("page-sorter").style.display = "none";

  document.getElementById("showMore").style.display = "inline";

  const shareText = `My %23tripleS Bias Ranking:%0A${listResult.join("%0A")}%0A> https://sssorter.pages.dev`;
  const tweetBtn = document.getElementById("tweet-button");

  tweetBtn.style.display = "inline-block";
  tweetBtn.href = `https://twitter.com/intent/tweet?text=${shareText}`;

  const sssongsBtn = document.getElementById("sssongs-button");
  sssongsBtn.style.display = "inline-block";
}

function toggleResult() {
  const showMoreText = document.getElementById("showMore").innerText;

  if (showMoreText === "Show More") {
    document.getElementById("showMore").innerText = "Show Less";
    showResult({ full: true });
  } else {
    document.getElementById("showMore").innerText = "Show More";
    showResult({ full: false });
  }
}

function showFinal({ skipIncrement = false, selectedFlag = 0 } = {}) {
  if (!skipIncrement) numQuestion++;

  const progressPercent = Math.floor((finishSize * 100) / totalSize);
  const heartCount = 5;
  const filledHearts = Math.floor((progressPercent / 100) * heartCount);
  const heartDisplay = "♥".repeat(filledHearts) + "♡".repeat(heartCount - filledHearts);
  var str0 = `<strong>Gravity #${numQuestion - 1}</strong><br>${heartDisplay} ${progressPercent}% sorted`;
  document.getElementById("battleNumber").innerHTML = str0;

  const optionA = document.getElementById("optionA");
  const optionB = document.getElementById("optionB");

  // Get the member indices currently displayed in optionA and optionB
  // Use -1 as a default if the data attribute is not set (initial load)
  const currentMemberIndexA = parseInt(optionA.dataset.memberIndex, 10) || -1;
  const currentMemberIndexB = parseInt(optionB.dataset.memberIndex, 10) || -1;

  // Determine the next member indices
  const nextMemberIndexA = lstMember[cmp1][head1];
  const nextMemberIndexB = lstMember[cmp2][head2];

  // Determine the next content
  const nextContentA = toNameFace(nextMemberIndexA);
  const nextContentB = toNameFace(nextMemberIndexB);

  // Remove any existing animation classes and inline styles
  optionA.classList.remove(
    "fade-out",
    "fade-in",
    "flip-out",
    "flip-in",
    "selected-glow",
  );
  optionB.classList.remove(
    "fade-out",
    "fade-in",
    "flip-out",
    "flip-in",
    "selected-glow",
  );
  optionA.style.opacity = ""; // Clear inline opacity
  optionB.style.opacity = ""; // Clear inline opacity
  optionA.style.transform = ""; // Clear inline transform
  optionB.style.transform = ""; // Clear inline transform

  if (selectedFlag === 0) {
    // Initial state or tie (if tie were active)
    optionA.innerHTML = nextContentA; // Use current heads for initial display
    optionB.innerHTML = nextContentB; // Use current heads for initial display
    // Set member color CSS variables
    optionA.style.setProperty('--member-color', memberColor[namMember[nextMemberIndexA]]);
    optionB.style.setProperty('--member-color', memberColor[namMember[nextMemberIndexB]]);
    // Set data-member-index for the initial state
    optionA.dataset.memberIndex = nextMemberIndexA;
    optionB.dataset.memberIndex = nextMemberIndexB;
    // Ensure they are visible initially
    optionA.style.visibility = "visible";
    optionB.style.visibility = "visible";
    optionA.style.opacity = 1;
    optionB.style.opacity = 1;
    return; // Exit the function
  }

  // Apply initial animation states based on content change and selection
  // Compare the member indices to see if the content is changing
  const optionAContentChanged = currentMemberIndexA !== nextMemberIndexA;
  const optionBContentChanged = currentMemberIndexB !== nextMemberIndexB;

  if (optionAContentChanged) {
    optionA.classList.add("flip-out");
  } else {
    // optionA.classList.add("fade-out"); // Use fade for no content change
  }

  if (optionBContentChanged) {
    optionB.classList.add("flip-out");
  } else {
    // optionB.classList.add("fade-out"); // Use fade for no content change
  }

  // Add glow to the selected option
  if (selectedFlag < 0) {
    // Option A was selected
    optionA.classList.add("selected-glow");
  } else {
    // Option B was selected
    optionB.classList.add("selected-glow");
  }

  // Wait for the fade-out/flip-out transition to complete
  setTimeout(() => {
    // Update content for the next battle
    optionA.innerHTML = nextContentA;
    optionB.innerHTML = nextContentB;
    // Set member color CSS variables
    optionA.style.setProperty('--member-color', memberColor[namMember[nextMemberIndexA]]);
    optionB.style.setProperty('--member-color', memberColor[namMember[nextMemberIndexB]]);
    // Update data-member-index after content update
    optionA.dataset.memberIndex = nextMemberIndexA;
    optionB.dataset.memberIndex = nextMemberIndexB;

    // Apply fade-in/flip-in animation
    if (optionAContentChanged) {
      optionA.classList.remove("flip-out");
      optionA.classList.add("flip-in");
    } else {
      optionA.classList.remove("fade-out");
      optionA.classList.add("fade-in");
    }

    if (optionBContentChanged) {
      optionB.classList.remove("flip-out");
      optionB.classList.add("flip-in");
    } else {
      optionB.classList.remove("fade-out");
      optionB.classList.add("fade-in");
    }

    // After the second transition, remove the animation classes and glow
    setTimeout(() => {
      optionA.classList.remove("fade-in", "flip-in", "selected-glow");
      optionB.classList.remove("fade-in", "flip-in", "selected-glow");
      // Ensure final state is visible and not transformed
      optionA.style.opacity = 1;
      optionB.style.opacity = 1;
      optionA.style.transform = "rotateY(0deg)";
      optionB.style.transform = "rotateY(0deg)";
    }, 200); // Match the transition duration
  }, 200); // Match the transition duration
}

function toNameFace(n) {
  const mem = namMember[n];
  const disp = `
    <div class='photocard-image-container'>
      <img src='${memberPicId[mem]}' alt='${mem}' class='photocard-image'/>
      <div class='member-badge'>${memberSNumber[mem]}</div>
    </div>
    <div class='photocard-info'>
      <div class='member-name' style='color: ${memberColor[mem]};'>${mem} ${memberEmoji[mem] || ""}</div>
    </div>
  `;

  return disp;
}
