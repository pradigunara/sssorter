var picSet1 = {
  SeoYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/03bf1f18-da5a-4554-5b57-50ca30b32200/2x",
  HyeRin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/4b672dca-5fdf-4c23-29dc-ed3764a6fc00/2x",
  JiWoo:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/c83c9cc2-d5f3-48b6-0199-79294c10d700/2x",
  ChaeYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/0716217f-31d3-433d-6dee-a1efeeea5700/2x",
  YooYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/3f4bdbcc-6909-4a88-b7dd-48674005ae00/2x",
  SooMin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/dc9cebef-a368-4874-b48f-c570d8bd4700/2x",
  NaKyoung:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/b4ac57ba-dcff-43cd-0d3a-34d209fb8e00/2x",
  YuBin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/c1a86acc-aed8-4696-cbe7-7d70c040f100/2x",
  Kaede:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/5465661c-d6f2-4e01-3aea-9c0d3432f900/2x",
  DaHyun:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/b833c51a-759d-4791-e1b6-ba022316ab00/2x",
  Kotone:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/d0c9a702-684f-4b82-184c-006b47eb9d00/2x",
  YeonJi:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/756121b9-5039-48c2-0631-ac6c699e2f00/2x",
  Nien: "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/d9359e03-f4b9-46f1-51e5-bfd19e621000/2x",
  SoHyun:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/76e1fa01-c28f-4827-bbe6-4c3bdee9b200/2x",
  Xinyu:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/bc561ebd-7357-4608-c4a3-7bad047a1400/2x",
  Mayu: "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/84eba7a0-bb87-4e95-5839-15a8c66dbf00/2x",
  Lynn: "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/c2297057-ab06-4ce3-c20d-388f9c54b500/2x",
  JooBin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/08688a9e-f754-48e5-2471-6a53341b5700/2x",
  HaYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/26bb202c-5394-40c3-6cf6-abde96d63400/2x",
  ShiOn:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/8766df55-2d91-49c7-1806-497aea1d5600/2x",
  ChaeWon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/a2dbeaea-4219-461c-e78a-4d55ed582d00/2x",
  Sullin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/835cc6d6-7091-4df0-a81b-61682fb5d400/2x",
  SeoAh:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/004c4f40-ea3f-4162-d018-fb6bf34ccb00/2x",
  JiYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/5cf73b72-b10b-4065-02dc-6c2c997a1900/2x",
};

var picSet2 = {
  SeoYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/416910dd-7cb6-4a59-c32d-2747d6ed0f00/2x",
  HyeRin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/bb6be3f1-66c3-42a7-d09c-aebfac5f0c00/2x",
  JiWoo:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/2b65ae80-386b-45bd-bd6b-85d9bf897700/2x",
  ChaeYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/2caae720-b7d2-4ddd-4ff0-883bd855a400/2x",
  YooYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/249f63f8-bd12-4996-fa6f-e1c657c07e00/2x",
  SooMin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/f9385887-1827-4fe7-06bb-df8522e53000/2x",
  NaKyoung:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/92072b2a-f286-48a1-fe2a-17be5c230900/2x",
  YuBin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/54d2a3b5-9b4f-40a9-e8ad-e6fec9f8fb00/2x",
  Kaede:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/0a71c37d-aea0-4084-3082-487d1cbed500/2x",
  DaHyun:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/525c992f-f833-419a-6ccd-17ed2c041f00/2x",
  Kotone:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/afef654a-db00-4d42-26f4-88569ec5f500/2x",
  YeonJi:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/0f41f89c-60f0-49c4-2afd-33c3f9913e00/2x",
  Nien: "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/ed3911e2-3df1-4e60-cc6f-ede8044a4000/2x",
  SoHyun:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/278653e6-39f6-40b1-3fc8-4468be6a3900/2x",
  Xinyu:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/c79dc356-1a81-4695-8e6a-123f9c1adf00/2x",
  Mayu: "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/26935eb3-8c0f-4155-ab44-a0e761a73a00/2x",
  Lynn: "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/b5b3221a-223b-48f6-eb58-db7c56188f00/2x",
  JooBin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/cd8122d6-4449-4cf3-0f5b-25863f11cc00/2x",
  HaYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/f35df853-be65-4c19-19c0-df9aee081700/2x",
  ShiOn:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/6d5233e1-62bf-4542-f1bd-1fc09f13cd00/2x",
  ChaeWon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/4e0122aa-d8e7-4ddf-9384-ddb41b068800/2x",
  Sullin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/4387873a-eb92-4cc7-57a3-c8261581b500/2x",
  SeoAh:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/5e319a09-95ce-4475-4ddb-34cc07e4dd00/2x",
  JiYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/fea28064-76ee-4af9-0608-677efbd50e00/2x",
};

var picSet3 = {
  SeoYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/b97887cf-c357-42c0-a828-e16fe2f7a100/2x",
  HyeRin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/f0dea376-64dd-4595-261e-779574759700/2x",
  JiWoo:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/cd7a6354-f140-4cf6-7e60-b653d3801000/2x",
  ChaeYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/30c1e20d-9fc8-47e4-151e-bed2427fa100/2x",
  YooYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/ff672444-6de5-46d7-6e20-006150048e00/2x",
  SooMin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/aaf4d6d3-fca8-402c-ec6b-0513d9fde200/2x",
  NaKyoung:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/501728a9-9df5-4b08-ff62-091cffb3f900/2x",
  YuBin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/e2b293a7-f129-4aea-96fa-b6f391e6ed00/2x",
  Kaede:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/c2471b88-ff29-4abe-6612-9e1793d30c00/2x",
  DaHyun:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/5f28a8e7-392c-4c19-1bca-b3f8fd295000/2x",
  Kotone:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/4e9bbee8-ae13-47cf-6563-32a87aa59f00/2x",
  YeonJi:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/6ec23f74-e9ef-4680-ee30-99645a8bd100/2x",
  Nien: "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/6c7b13bc-b785-4af2-1161-c7314f0d5000/2x",
  SoHyun:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/cbfd7149-9268-4382-b2bf-be144a4bf400/2x",
  Xinyu:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/0f10339c-bf4e-48c4-fa36-93c9631b6700/2x",
  Mayu: "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/35e47ea3-252b-44d6-acae-08a15af93e00/2x",
  Lynn: "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/fad62fa9-f2aa-4c08-e19a-96a42b249a00/2x",
  JooBin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/2f622bea-832e-41e2-1e66-74c914aa0f00/2x",
  HaYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/a1aeb5d6-a752-47b7-2530-8e3f3a89ca00/2x",
  ShiOn:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/7ebf7501-ba0a-4adb-9d3a-bc9c9c107300/2x",
  ChaeWon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/b5849b3f-f388-4a00-0836-c1518f8f6f00/2x",
  Sullin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/7a8bf04f-b935-4add-1e15-6a7e88e33f00/2x",
  SeoAh:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/52bb3ac7-273c-49ac-51a4-415f76f22a00/2x",
  JiYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/98d134ac-bb5e-4fdb-82f6-cd39119d0c00/2x",
};

var picSet4 = {
  SeoYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/6f8b3a9c-9231-4e01-9b49-dacdf2908d00/2x",
  HyeRin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/9f85fe1e-9a65-48f6-250e-d25ce6078800/2x",
  JiWoo:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/6e2575bb-a943-4541-b909-49e5ea59ea00/2x",
  ChaeYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/d2bec75c-2fa7-4386-039d-5a1a1cba4600/2x",
  YooYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/534e1c60-b1e2-4b06-198b-49cd98069500/2x",
  SooMin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/7705db9e-325d-4d94-ebce-cae9570fb600/2x",
  NaKyoung:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/ba1e37ac-ba7d-48d2-4948-ca34a27c8b00/2x",
  YuBin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/df0ee1ae-b6b5-4caf-58c7-f1d4a470a600/2x",
  Kaede:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/f01a7cd6-b8ec-4092-1ca1-204fdada1100/2x",
  DaHyun:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/1586be14-581d-495d-2c3e-6bae64091400/2x",
  Kotone:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/d7cb509c-736c-448d-55cb-9b45fd90ef00/2x",
  YeonJi:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/d1b0ab30-b3c2-4900-915a-1e48da76c300/2x",
  Nien: "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/d07869c3-6423-40cb-ea24-126704655500/2x",
  SoHyun:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/70f2c3c1-6461-4053-8367-19641c3fce00/2x",
  Xinyu:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/51a4cc9e-d295-49e5-8b65-f6098f6eaf00/2x",
  Mayu: "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/268170a7-eb3d-4d76-ce21-66d0e3cf1a00/2x",
  Lynn: "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/c391b879-c81c-405f-05b4-0bbef8838d00/2x",
  JooBin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/3d7b55b6-6137-4003-e205-78b6e6964e00/2x",
  HaYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/b3b0fdd5-50de-4c9b-8a8a-23a22f904500/2x",
  ShiOn:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/14d056f6-cada-4cbd-690a-32639d066800/2x",
  ChaeWon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/e8ef96e9-912f-46fb-6783-219e79379d00/2x",
  Sullin:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/d1ba0d7f-349a-44ec-73e5-fbb964ba2200/2x",
  SeoAh:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/46cf9aaa-dba6-4f7c-30d9-bb8e14323f00/2x",
  JiYeon:
    "https://imagedelivery.net/qQuMkbHJ-0s6rwu8vup_5w/6e3b3fb9-4042-447a-541f-ca039d59a900/2x",
};

var rand = (min, max) => Math.floor(Math.random() * (max - min + 1) + min);
var memberPicId = {};

initMemberPic();

function initMemberPic() {
  const isDarkMode = localStorage.getItem("darkMode") === "true";
  const picSets = isDarkMode ? [picSet3, picSet4] : [picSet1, picSet2];
  memberPicId = picSets[rand(0, 1)];
}

// Preload images
function preloadImages() {
  const picSets = [picSet1, picSet2, picSet3, picSet4];
  for (const picSet of picSets) {
    for (const member in picSet) {
      if (picSet.hasOwnProperty(member)) {
        const img = new Image();
        img.src = picSet[member];
      }
    }
  }
}

// Dark mode functionality
function toggleDarkMode() {
  const body = document.body;
  const isDarkMode = body.classList.toggle("dark-mode");
  const themeToggleText = document.querySelector(".theme-toggle-text");
  const themeToggleIcon = document.querySelector(".theme-toggle-icon svg");

  // Update toggle text and icon
  if (isDarkMode) {
    themeToggleText.textContent = "Light Mode";
    themeToggleIcon.innerHTML =
      '<path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
  } else {
    themeToggleText.textContent = "#DarkMode";
    themeToggleIcon.innerHTML =
      '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
  }

  // Save preference to localStorage
  localStorage.setItem("darkMode", isDarkMode);
  initMemberPic();
  showFinal({ skipIncrement: true });
}

// Check for saved theme preference on page load
document.addEventListener("DOMContentLoaded", function () {
  const savedDarkMode = localStorage.getItem("darkMode");
  initMemberPic();

  if (savedDarkMode === "true") {
    document.body.classList.add("dark-mode");
    document.querySelector(".theme-toggle-text").textContent = "Light Mode";
    document.querySelector(".theme-toggle-icon svg").innerHTML =
      '<path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
  }

  // Call preloadImages
  preloadImages();
});

var memberColor = {
  SeoYeon: "#21AEFE",
  HyeRin: "#830CE8",
  JiWoo: "#FDF70A",
  ChaeYeon: "#98C64A",
  YooYeon: "#DC0B74",
  SooMin: "#F985A4",
  NaKyoung: "#659AA0",
  YuBin: "#FDE4E0",
  Kaede: "#FDB634",
  DaHyun: "#FE9BD6",
  Kotone: "#E3C500",
  YeonJi: "#5974FA",
  Nien: "#FD963D",
  SoHyun: "#1223B2",
  Xinyu: "#CA1E20",
  Mayu: "#FB9074",
  Lynn: "#AC60B8",
  JooBin: "#B7F54C",
  HaYeon: "#52D8BB",
  ShiOn: "#FF428A",
  ChaeWon: "#C3A4E0",
  Sullin: "#7DBA8D",
  SeoAh: "#D0F3FF",
  JiYeon: "#FFAB64",
};

var memberEmoji = {
  SeoYeon: "üê∂",
  HyeRin: "üê±",
  JiWoo: "üêª",
  ChaeYeon: "ü¶å",
  YooYeon: "üê∞",
  SooMin: "üêøÔ∏è",
  NaKyoung: "üêà",
  YuBin: "üêØ",
  Kaede: "üçÅ",
  DaHyun: "üçí",
  Kotone: "ü¶≠",
  YeonJi: "ü¶Ü",
  Nien: "üêë",
  SoHyun: "üê∫",
  Xinyu: "ü¶ä",
  Mayu: "üêá",
  Lynn: "ü¶à",
  JooBin: "üê£",
  HaYeon: "üêπ",
  ShiOn: "üçû",
  ChaeWon: "üéÄ",
  Sullin: "‚õÑÔ∏è",
  SeoAh: "‚òÄÔ∏è",
  JiYeon: "ü¶¢",
};

var memberSNumber = {
  SeoYeon: "S1",
  HyeRin: "S2",
  JiWoo: "S3",
  ChaeYeon: "S4",
  YooYeon: "S5",
  SooMin: "S6",
  NaKyoung: "S7",
  YuBin: "S8",
  Kaede: "S9",
  DaHyun: "S10",
  Kotone: "S11",
  YeonJi: "S12",
  Nien: "S13",
  SoHyun: "S14",
  Xinyu: "S15",
  Mayu: "S16",
  Lynn: "S17",
  JooBin: "S18",
  HaYeon: "S19",
  ShiOn: "S20",
  ChaeWon: "S21",
  Sullin: "S22",
  SeoAh: "S23",
  JiYeon: "S24",
};

var namMember = new Array(
  "SeoYeon",
  "HyeRin",
  "JiWoo",
  "ChaeYeon",
  "YooYeon",
  "SooMin",
  "NaKyoung",
  "YuBin",
  "Kaede",
  "DaHyun",
  "Kotone",
  "YeonJi",
  "Nien",
  "SoHyun",
  "Xinyu",
  "Mayu",
  "Lynn",
  "JooBin",
  "HaYeon",
  "ShiOn",
  "ChaeWon",
  "Sullin",
  "SeoAh",
  "JiYeon",
);

var lstMember = new Array();
var parent = new Array();
var equal = new Array();
var rec = new Array();
var cmp1, cmp2;
var head1, head2;
var nrec;
var numQuestion;
var totalSize;
var finishSize;
var finishFlag;

function initList() {
  const memEmojis = Object.values(memberEmoji);
  const topEmojis = memEmojis.slice(0, 12).join(" ");
  const botEmojis = memEmojis.slice(12).join(" ");
  document.getElementById("member-emojis").innerHTML =
    `${topEmojis}<br/>${botEmojis}`;
  namMember.sort(() => 0.5 - Math.random());

  var n = 0;
  var mid;
  var i;

  lstMember[n] = new Array();

  for (i = 0; i < namMember.length; i++) {
    lstMember[n][i] = i;
  }

  parent[n] = -1;
  totalSize = 0;
  n++;

  for (i = 0; i < lstMember.length; i++) {
    if (lstMember[i].length >= 2) {
      mid = Math.ceil(lstMember[i].length / 2);
      lstMember[n] = new Array();
      lstMember[n] = lstMember[i].slice(0, mid);
      totalSize += lstMember[n].length;
      parent[n] = i;
      n++;
      lstMember[n] = new Array();
      lstMember[n] = lstMember[i].slice(mid, lstMember[i].length);
      totalSize += lstMember[n].length;
      parent[n] = i;
      n++;
    }
  }

  for (i = 0; i < namMember.length; i++) {
    rec[i] = 0;
  }

  nrec = 0;

  for (i = 0; i <= namMember.length; i++) {
    equal[i] = -1;
  }

  cmp1 = lstMember.length - 2;
  cmp2 = lstMember.length - 1;
  head1 = 0;
  head2 = 0;
  numQuestion = 1;
  finishSize = 0;
  finishFlag = 0;
}

// Preload critical member images for first comparison
function preloadInitialImages() {
  if (lstMember[cmp1] && lstMember[cmp2]) {
    const memberAIndex = lstMember[cmp1][head1];
    const memberBIndex = lstMember[cmp2][head2];

    if (memberAIndex !== undefined && memberBIndex !== undefined) {
      const memberAName = namMember[memberAIndex];
      const memberBName = namMember[memberBIndex];

      // Preload all image sets for these members
      [picSet1, picSet2, picSet3, picSet4].forEach((picSet) => {
        if (picSet[memberAName]) {
          const imgA = new Image();
          imgA.src = picSet[memberAName];
        }
        if (picSet[memberBName]) {
          const imgB = new Image();
          imgB.src = picSet[memberBName];
        }
      });
    }
  }
}

function sortList(flag) {
  var i;
  var str;

  if (flag < 0) {
    rec[nrec] = lstMember[cmp1][head1];
    head1++;
    nrec++;
    finishSize++;

    while (equal[rec[nrec - 1]] != -1) {
      rec[nrec] = lstMember[cmp1][head1];
      head1++;
      nrec++;
      finishSize++;
    }
  } else if (flag > 0) {
    rec[nrec] = lstMember[cmp2][head2];
    head2++;
    nrec++;
    finishSize++;

    while (equal[rec[nrec - 1]] != -1) {
      rec[nrec] = lstMember[cmp2][head2];
      head2++;
      nrec++;
      finishSize++;
    }
  } else {
    rec[nrec] = lstMember[cmp1][head1];
    head1++;
    nrec++;
    finishSize++;
    while (equal[rec[nrec - 1]] != -1) {
      rec[nrec] = lstMember[cmp1][head1];
      head1++;
      nrec++;
      finishSize++;
    }
    equal[rec[nrec - 1]] = lstMember[cmp2][head2];
    rec[nrec] = lstMember[cmp2][head2];
    head2++;
    nrec++;
    finishSize++;
    while (equal[rec[nrec - 1]] != -1) {
      rec[nrec] = lstMember[cmp2][head2];
      head2++;
      nrec++;
      finishSize++;
    }
  }

  if (head1 < lstMember[cmp1].length && head2 == lstMember[cmp2].length) {
    while (head1 < lstMember[cmp1].length) {
      rec[nrec] = lstMember[cmp1][head1];
      head1++;
      nrec++;
      finishSize++;
    }
  } else if (
    head1 == lstMember[cmp1].length &&
    head2 < lstMember[cmp2].length
  ) {
    while (head2 < lstMember[cmp2].length) {
      rec[nrec] = lstMember[cmp2][head2];
      head2++;
      nrec++;
      finishSize++;
    }
  }

  if (head1 == lstMember[cmp1].length && head2 == lstMember[cmp2].length) {
    for (i = 0; i < lstMember[cmp1].length + lstMember[cmp2].length; i++) {
      lstMember[parent[cmp1]][i] = rec[i];
    }

    lstMember.pop();
    lstMember.pop();
    cmp1 = cmp1 - 2;
    cmp2 = cmp2 - 2;
    head1 = 0;
    head2 = 0;

    if (head1 == 0 && head2 == 0) {
      for (i = 0; i < namMember.length; i++) {
        rec[i] = 0;
      }
      nrec = 0;
    }
  }

  if (cmp1 < 0) {
    const progressPercent = Math.floor((finishSize * 100) / totalSize);
    const heartCount = 5;
    const filledHearts = Math.floor((progressPercent / 100) * heartCount);
    const heartDisplay =
      "‚ô•".repeat(filledHearts) + "‚ô°".repeat(heartCount - filledHearts);
    str = `<strong>Gravity #${numQuestion - 1}</strong><br>${heartDisplay} ${progressPercent}% sorted`;
    document.getElementById("battleNumber").innerHTML = str;
    showResult();
    finishFlag = 1;
  } else {
    // Pass the flag to showFinal - defer to allow interaction response to paint first
    requestAnimationFrame(() => {
      showFinal({ selectedFlag: flag });
    });
  }
}

function showResult({ full = false } = {}) {
  var ranking = 1;
  var sameRank = 1;
  var str = "";
  var i;
  var listResult = [];

  var iterCount = full ? namMember.length : namMember.length / 2;

  str += "<div class='results-list'><h2>Bias Ranking Result</h2><ul>";
  for (i = 0; i < iterCount; i++) {
    const mem = namMember[lstMember[0][i]];
    const disp = `${mem}${memberEmoji[mem]}`;
    listResult.push(disp);

    str += "<li><span class='number'>" + ranking + "</span> " + disp + "</li>";

    if (i < iterCount - 1) {
      if (equal[lstMember[0][i]] == lstMember[0][i + 1]) {
        sameRank++;
      } else {
        ranking += sameRank;
        sameRank = 1;
      }
    }
  }

  str += "</ul>";
  document.getElementById("battleResult").innerHTML = str;
  document.getElementById("page-sorter").style.display = "none";

  document.getElementById("showMore").style.display = "inline";

  const shareText = `My %23tripleS Bias Ranking:%0A${listResult.join("%0A")}%0A> https://sssorter.pages.dev`;
  const tweetBtn = document.getElementById("tweet-button");

  tweetBtn.style.display = "inline-block";
  tweetBtn.href = `https://twitter.com/intent/tweet?text=${shareText}`;

  const sssongsBtn = document.getElementById("sssongs-button");
  sssongsBtn.style.display = "inline-block";
}

function toggleResult() {
  const showMoreText = document.getElementById("showMore").innerText;

  if (showMoreText === "Show More") {
    document.getElementById("showMore").innerText = "Show Less";
    showResult({ full: true });
  } else {
    document.getElementById("showMore").innerText = "Show More";
    showResult({ full: false });
  }
}

function showFinal({ skipIncrement = false, selectedFlag = 0 } = {}) {
  if (!skipIncrement) numQuestion++;

  const progressPercent = Math.floor((finishSize * 100) / totalSize);
  const heartCount = 5;
  const filledHearts = Math.floor((progressPercent / 100) * heartCount);
  const heartDisplay =
    "‚ô•".repeat(filledHearts) + "‚ô°".repeat(heartCount - filledHearts);
  var str0 = `<strong>Gravity #${numQuestion - 1}</strong><br>${heartDisplay} ${progressPercent}% sorted`;
  document.getElementById("battleNumber").innerHTML = str0;

  const optionA = document.getElementById("optionA");
  const optionB = document.getElementById("optionB");

  // Get the member indices currently displayed in optionA and optionB
  // Use -1 as a default if the data attribute is not set (initial load)
  const currentMemberIndexA = parseInt(optionA.dataset.memberIndex, 10) || -1;
  const currentMemberIndexB = parseInt(optionB.dataset.memberIndex, 10) || -1;

  // Determine the next member indices
  const nextMemberIndexA = lstMember[cmp1][head1];
  const nextMemberIndexB = lstMember[cmp2][head2];

  // Determine the next content
  const nextContentA = toNameFace(nextMemberIndexA);
  const nextContentB = toNameFace(nextMemberIndexB);

  // Batch DOM cleanup operations
  optionA.classList.remove(
    "fade-out",
    "fade-in",
    "flip-out",
    "flip-in",
    "selected-glow",
  );
  optionA.style.cssText = ""; // Clear all inline styles at once

  optionB.classList.remove(
    "fade-out",
    "fade-in",
    "flip-out",
    "flip-in",
    "selected-glow",
  );
  optionB.style.cssText = ""; // Clear all inline styles at once

  if (selectedFlag === 0) {
    // Initial state or tie (if tie were active) - batch all updates
    optionA.innerHTML = nextContentA;
    optionA.style.setProperty(
      "--member-color",
      memberColor[namMember[nextMemberIndexA]],
    );
    optionA.dataset.memberIndex = nextMemberIndexA;
    optionA.style.visibility = "visible";
    optionA.style.opacity = 1;

    optionB.innerHTML = nextContentB;
    optionB.style.setProperty(
      "--member-color",
      memberColor[namMember[nextMemberIndexB]],
    );
    optionB.dataset.memberIndex = nextMemberIndexB;
    optionB.style.visibility = "visible";
    optionB.style.opacity = 1;
    return; // Exit the function
  }

  // Apply initial animation states based on content change and selection
  // Compare the member indices to see if the content is changing
  const optionAContentChanged = currentMemberIndexA !== nextMemberIndexA;
  const optionBContentChanged = currentMemberIndexB !== nextMemberIndexB;

  if (optionAContentChanged) {
    optionA.classList.add("flip-out");
  } else {
    // optionA.classList.add("fade-out"); // Use fade for no content change
  }

  if (optionBContentChanged) {
    optionB.classList.add("flip-out");
  } else {
    // optionB.classList.add("fade-out"); // Use fade for no content change
  }

  // Add glow to the selected option
  if (selectedFlag < 0) {
    // Option A was selected
    optionA.classList.add("selected-glow");
  } else {
    // Option B was selected
    optionB.classList.add("selected-glow");
  }

  // Wait for the fade-out/flip-out transition to complete
  setTimeout(() => {
    // Batch DOM updates to prevent layout thrashing
    requestAnimationFrame(() => {
      // Update content and properties in batch
      optionA.innerHTML = nextContentA;
      optionA.style.setProperty(
        "--member-color",
        memberColor[namMember[nextMemberIndexA]],
      );
      optionA.dataset.memberIndex = nextMemberIndexA;

      optionB.innerHTML = nextContentB;
      optionB.style.setProperty(
        "--member-color",
        memberColor[namMember[nextMemberIndexB]],
      );
      optionB.dataset.memberIndex = nextMemberIndexB;

      // Apply animations after DOM updates
      if (optionAContentChanged) {
        optionA.classList.remove("flip-out");
        optionA.classList.add("flip-in");
      } else {
        optionA.classList.remove("fade-out");
        optionA.classList.add("fade-in");
      }

      if (optionBContentChanged) {
        optionB.classList.remove("flip-out");
        optionB.classList.add("flip-in");
      } else {
        optionB.classList.remove("fade-out");
        optionB.classList.add("fade-in");
      }
    });

    // After the second transition, remove the animation classes and glow
    setTimeout(() => {
      optionA.classList.remove("fade-in", "flip-in", "selected-glow");
      optionB.classList.remove("fade-in", "flip-in", "selected-glow");
      // Ensure final state is visible and not transformed
      optionA.style.opacity = 1;
      optionB.style.opacity = 1;
      optionA.style.transform = "rotateY(0deg)";
      optionB.style.transform = "rotateY(0deg)";
    }, 200); // Match the transition duration
  }, 200); // Match the transition duration
}

function toNameFace(n) {
  const mem = namMember[n];
  const disp = `
    <div class='photocard-image-container'>
      <img src='${memberPicId[mem]}' alt='${mem}' class='photocard-image'/>
      <div class='member-badge'>${memberSNumber[mem]}</div>
    </div>
    <div class='photocard-info'>
      <div class='member-name' style='color: ${memberColor[mem]};'>${mem} ${memberEmoji[mem] || ""}</div>
    </div>
  `;

  return disp;
}
